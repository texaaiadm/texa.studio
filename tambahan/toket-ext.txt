<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Vault - Firebase Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Scrollbar Style -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        
        /* Utility for hiding/showing elements */
        .hidden-tab { display: none; }
        .active-tab { display: block; }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-blue-500 selection:text-white">

    <!-- APP CONTAINER -->
    <div id="main-app" class="p-4 md:p-8 max-w-4xl mx-auto space-y-6">
        
        <!-- HEADER -->
        <div class="flex items-center justify-between border-b border-slate-800 pb-6">
            <div class="flex items-center gap-3">
                <div class="p-3 bg-blue-600 rounded-xl shadow-lg shadow-blue-900/20">
                    <i data-lucide="database" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Token Vault</h1>
                    <p class="text-slate-400 text-sm">Deployable Firebase Token Storage</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="btn-tab-manager" onclick="switchTab('manager')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-slate-800 text-white">
                    Manager
                </button>
                <button id="btn-tab-api" onclick="switchTab('api')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white">
                    API & Ekstensi
                </button>
            </div>
        </div>

        <!-- TAB: MANAGER -->
        <div id="tab-manager" class="active-tab">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- INPUT FORM -->
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="shield-check" class="w-5 h-5 text-emerald-400"></i>
                        <h2 class="text-lg font-semibold text-white">Input Token Baru</h2>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-semibold">ID Token (Key)</label>
                            <div class="relative">
                                <i data-lucide="key" class="absolute left-3 top-3 w-4 h-4 text-slate-500"></i>
                                <input type="text" id="input-token-id" value="google_oauth_user_1" 
                                    class="w-full bg-slate-950 border border-slate-800 rounded-lg py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600"
                                    placeholder="Contoh: user_123">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-semibold">Bearer Token</label>
                            <textarea id="input-bearer-token" 
                                class="w-full h-32 bg-slate-950 border border-slate-800 rounded-lg p-4 text-xs font-mono focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-slate-300 placeholder-slate-600 resize-none custom-scrollbar"
                                placeholder="ya29..."></textarea>
                        </div>
                        <button id="btn-save" onclick="handleSave()" 
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-900/20">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span id="btn-save-text">Simpan ke Database</span>
                        </button>
                        
                        <!-- Status Message -->
                        <div id="status-container" class="hidden p-3 rounded-lg text-xs flex items-center gap-2">
                            <i id="status-icon" data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span id="status-msg"></span>
                        </div>
                    </div>
                </div>

                <!-- LIVE DATA DISPLAY -->
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-lg font-semibold text-white">Data di Database</h2>
                        </div>
                        <span id="badge-live" class="hidden text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-400 border border-slate-700">Live Sync</span>
                    </div>
                    
                    <div id="live-data-content" class="flex-1 bg-slate-950 rounded-xl border border-slate-800 p-4 overflow-hidden relative group">
                        <!-- Content will be injected here by JS -->
                        <div class="h-full flex flex-col items-center justify-center text-slate-600 gap-3">
                            <i data-lucide="database" class="w-10 h-10 opacity-20"></i>
                            <p class="text-sm">Menunggu koneksi...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: API -->
        <div id="tab-api" class="hidden-tab">
            <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl">
                <div class="p-6 border-b border-slate-800">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="terminal" class="w-5 h-5 text-purple-400"></i>
                        <h2 class="text-lg font-semibold text-white">Integrasi Ekstensi</h2>
                    </div>
                    <p class="text-slate-400 text-sm">
                        Panduan untuk <strong>Mengambil (GET)</strong> dan <strong>Menyimpan (POST)</strong> token langsung dari skrip Ekstensi Anda.
                    </p>
                </div>

                <div class="p-6 space-y-8">
                    <!-- API Endpoint -->
                    <div>
                        <label class="flex items-center justify-between text-xs uppercase tracking-wider text-slate-500 mb-2 font-semibold">
                            <span>API Endpoint Utama</span>
                        </label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="external-link" class="h-4 w-4 text-slate-500"></i>
                            </div>
                            <input type="text" id="api-url-input" readonly 
                                class="w-full bg-slate-950 border border-slate-800 text-slate-300 text-xs font-mono rounded-lg py-3 pl-10 pr-12 focus:outline-none focus:border-purple-500 transition-all">
                            <button onclick="copyApiUrl(this)" class="absolute right-2 top-2 p-1.5 hover:bg-slate-800 rounded-md transition-colors text-slate-400 hover:text-white">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- GET Snippet -->
                    <div class="border border-slate-800 rounded-xl overflow-hidden">
                        <div class="bg-slate-900/50 p-3 border-b border-slate-800 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="download-cloud" class="w-4 h-4 text-blue-400"></i>
                                <span class="text-xs font-semibold text-slate-300">CARA 1: AMBIL TOKEN DARI DB</span>
                            </div>
                            <button onclick="copyGetCode(this)" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> Copy Snippet
                            </button>
                        </div>
                        <div class="p-4 bg-slate-950 overflow-x-auto custom-scrollbar">
                            <pre id="code-get-display" class="text-xs font-mono text-slate-400 whitespace-pre"></pre>
                        </div>
                    </div>

                    <!-- SAVE Snippet -->
                    <div class="border border-slate-800 rounded-xl overflow-hidden">
                        <div class="bg-slate-900/50 p-3 border-b border-slate-800 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="upload-cloud" class="w-4 h-4 text-emerald-400"></i>
                                <span class="text-xs font-semibold text-slate-300">CARA 2: SIMPAN TOKEN DARI EKSTENSI</span>
                            </div>
                            <button onclick="copySaveCode(this)" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> Copy Snippet
                            </button>
                        </div>
                        <div class="p-4 bg-slate-950 overflow-x-auto custom-scrollbar">
                            <pre id="code-save-display" class="text-xs font-mono text-emerald-400/80 whitespace-pre"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PERMISSION ERROR MODAL (Overlay) -->
    <div id="error-screen" class="hidden fixed inset-0 z-50 bg-slate-950 text-slate-200 p-8 flex items-center justify-center overflow-y-auto">
        <div class="max-w-2xl w-full bg-slate-900 border border-red-900/50 rounded-2xl p-8 shadow-2xl">
            <div class="flex items-center gap-3 mb-6 text-red-400">
                <i data-lucide="lock" class="w-8 h-8"></i>
                <h1 class="text-2xl font-bold text-white">Akses Database Ditolak</h1>
            </div>
            <p class="text-slate-300 mb-6 leading-relaxed">
                Aplikasi tidak diizinkan membaca/menulis ke database. Anda perlu membuka akses di Firebase Console agar Ekstensi dan Dashboard bisa bekerja.
            </p>
            <div class="bg-slate-950 rounded-xl border border-slate-800 p-6 mb-6">
                <h3 class="text-sm font-semibold text-blue-400 mb-3 flex items-center gap-2">
                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                    SOLUSI: Update Firestore Rules
                </h3>
                <ol class="list-decimal list-inside text-sm text-slate-400 space-y-2 mb-4">
                    <li>Buka <a id="link-firestore-rules" href="#" target="_blank" class="text-blue-400 hover:underline">Firebase Console &rarr; Firestore &rarr; Rules</a></li>
                    <li>Paste kode di bawah ini:</li>
                </ol>
                <div class="relative group">
                    <pre class="bg-slate-900 p-4 rounded-lg text-xs font-mono text-emerald-400 overflow-x-auto border border-slate-800">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/tokens/{tokenId} {
      allow read, write: if true;
    }
  }
}
                    </pre>
                    <button onclick="copyRules(this)" class="absolute right-2 top-2 p-2 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 text-xs flex items-center gap-1 transition-colors">
                        <i data-lucide="copy" class="w-3 h-3"></i> Copy Rules
                    </button>
                </div>
            </div>
            <button onclick="window.location.reload()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 rounded-lg transition-all">
                Coba Lagi
            </button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYHrCidW3vrJHldgEbHqjeYYphl5f7DlM",
            authDomain: "texa-f4b30.firebaseapp.com",
            projectId: "texa-f4b30",
            storageBucket: "texa-f4b30.firebasestorage.app",
            messagingSenderId: "922894298029",
            appId: "1:922894298029:web:5c1bf375c2bb61b0cb8f24",
            measurementId: "G-QVBGFMKBG9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // App ID detection
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'my-token-vault';

        // State
        let currentUser = null;
        let currentTokenId = 'google_oauth_user_1';
        let unsubscribeSnapshot = null;

        // --- UI REFS ---
        const inputId = document.getElementById('input-token-id');
        const inputBearer = document.getElementById('input-bearer-token');
        const statusContainer = document.getElementById('status-container');
        const statusMsg = document.getElementById('status-msg');
        const statusIcon = document.getElementById('status-icon');
        const btnSave = document.getElementById('btn-save');
        const btnSaveText = document.getElementById('btn-save-text');
        const liveDataContent = document.getElementById('live-data-content');
        const badgeLive = document.getElementById('badge-live');
        const errorScreen = document.getElementById('error-screen');
        const mainApp = document.getElementById('main-app');
        const linkRules = document.getElementById('link-firestore-rules');
        const apiUrlInput = document.getElementById('api-url-input');
        const codeGetDisplay = document.getElementById('code-get-display');
        const codeSaveDisplay = document.getElementById('code-save-display');

        // Set Link URL
        linkRules.href = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules`;

        // --- 1. AUTHENTICATION ---
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                showStatus('error', 'Gagal autentikasi: ' + error.message);
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                errorScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                setupRealtimeListener();
            }
        });

        // --- 2. LISTENER DATA LIVE ---
        function setupRealtimeListener() {
            if (!currentUser) return;
            if (unsubscribeSnapshot) unsubscribeSnapshot();

            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'tokens', currentTokenId);

            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                // Hide error screen if visible
                errorScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderLiveData(data);
                } else {
                    renderLiveData(null);
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
                if (error.code === 'permission-denied') {
                    showPermissionError();
                }
            });
            
            // Update API snippets whenever ID changes
            updateSnippets();
        }

        function renderLiveData(data) {
            badgeLive.classList.remove('hidden');
            if (data) {
                liveDataContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <span class="text-xs text-slate-500 uppercase tracking-wider">ID</span>
                            <div class="text-sm font-mono text-emerald-400 mt-1">${data.id}</div>
                        </div>
                        <div>
                            <span class="text-xs text-slate-500 uppercase tracking-wider">Token Value</span>
                            <div class="mt-1 p-3 bg-slate-900 rounded-lg border border-slate-800 break-all text-xs font-mono text-slate-300 leading-relaxed max-h-40 overflow-y-auto custom-scrollbar">
                                ${data.token}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                liveDataContent.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-600 gap-3">
                        <i data-lucide="database" class="w-10 h-10 opacity-20"></i>
                        <p class="text-sm">Belum ada data untuk ID "${currentTokenId}"</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // --- 3. HANDLE SAVE ---
        window.handleSave = async () => {
            const tokenVal = inputBearer.value.trim();
            if (!currentUser) {
                showStatus('error', 'Menunggu koneksi database...');
                return;
            }
            if (!currentTokenId || !tokenVal) {
                showStatus('error', 'ID dan Token tidak boleh kosong.');
                return;
            }

            // UI Loading state
            btnSave.disabled = true;
            btnSaveText.innerText = "Menyimpan...";
            showStatus('loading', 'Menyimpan ke database...');

            try {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'tokens', currentTokenId);
                
                await setDoc(docRef, {
                    id: currentTokenId,
                    token: tokenVal,
                    updatedAt: serverTimestamp(),
                    note: "Token ini disimpan dari Dashboard HTML"
                });

                showStatus('success', 'Berhasil disimpan!');
                setTimeout(() => hideStatus(), 3000);
            } catch (error) {
                console.error(error);
                if (error.code === 'permission-denied') {
                    showPermissionError();
                    showStatus('error', 'Gagal: Izin Database Ditolak.');
                } else {
                    showStatus('error', 'Gagal: ' + error.message);
                }
            } finally {
                btnSave.disabled = false;
                btnSaveText.innerText = "Simpan ke Database";
            }
        };

        // --- UTILS ---
        
        // Input Listener for ID change
        inputId.addEventListener('input', (e) => {
            currentTokenId = e.target.value;
            // Debounce Listener restart
            setupRealtimeListener();
        });

        function showStatus(type, msg) {
            statusContainer.classList.remove('hidden', 'bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/20', 'bg-red-500/10', 'text-red-400', 'border-red-500/20');
            statusMsg.innerText = msg;
            
            if (type === 'success') {
                statusContainer.classList.add('bg-emerald-500/10', 'text-emerald-400', 'border', 'border-emerald-500/20');
                statusIcon.setAttribute('data-lucide', 'check');
            } else {
                statusContainer.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500/20');
                statusIcon.setAttribute('data-lucide', 'alert-circle');
            }
            lucide.createIcons();
        }

        function hideStatus() {
            statusContainer.classList.add('hidden');
        }

        function showPermissionError() {
            mainApp.classList.add('hidden');
            errorScreen.classList.remove('hidden');
        }

        // --- SNIPPET GENERATION ---
        function updateSnippets() {
            const apiPath = `artifacts/${APP_ID}/public/data/tokens/${currentTokenId}`;
            const restApiUrl = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/${apiPath}`;
            
            apiUrlInput.value = restApiUrl;

            // Generate Get Code
            codeGetDisplay.textContent = `// Fungsi untuk Mengambil Token (READ)
async function getTokenFromDB() {
  const url = "${restApiUrl}";
  
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("Data tidak ditemukan");
    
    const data = await response.json();
    // Struktur JSON Firestore: { fields: { token: { stringValue: "..." } } }
    const myToken = data.fields?.token?.stringValue;
    
    console.log("Token dari DB:", myToken);
    return myToken;
  } catch (error) {
    console.error("Gagal ambil token:", error);
    return null;
  }
}`;

            // Generate Save Code
            codeSaveDisplay.textContent = `// Fungsi untuk Menyimpan Token (WRITE)
async function saveTokenToDB(newToken) {
  const url = "${restApiUrl}";
  
  const body = {
    fields: {
      token: { stringValue: newToken },
      id: { stringValue: "${currentTokenId}" },
      updatedAt: { timestampValue: new Date().toISOString() },
      note: { stringValue: "Disimpan dari Ekstensi" }
    }
  };

  try {
    const response = await fetch(url, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    
    if (response.ok) console.log("Token berhasil di-update!");
  } catch (error) {
    console.error("Error saving token:", error);
  }
}`;
        }

        // Initialize Snippets on load
        updateSnippets();

    </script>

    <!-- UI INTERACTION SCRIPTS (Non-Module for global access) -->
    <script>
        // Init Icons
        lucide.createIcons();

        // Tabs Logic
        function switchTab(tabName) {
            const tabManager = document.getElementById('tab-manager');
            const tabApi = document.getElementById('tab-api');
            const btnManager = document.getElementById('btn-tab-manager');
            const btnApi = document.getElementById('btn-tab-api');

            if (tabName === 'manager') {
                tabManager.classList.remove('hidden-tab');
                tabManager.classList.add('active-tab');
                tabApi.classList.add('hidden-tab');
                tabApi.classList.remove('active-tab');

                btnManager.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all bg-slate-800 text-white";
                btnApi.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            } else {
                tabManager.classList.add('hidden-tab');
                tabManager.classList.remove('active-tab');
                tabApi.classList.remove('hidden-tab');
                tabApi.classList.add('active-tab');

                btnApi.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all bg-blue-600/20 text-blue-400 border border-blue-600/50";
                btnManager.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            }
        }

        // Copy Clipboard Helpers
        function copyToClipboard(text, btnElement, originalText = "Copy Snippet") {
            navigator.clipboard.writeText(text);
            const originalHTML = btnElement.innerHTML;
            
            // Change button state
            btnElement.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Copied!';
            lucide.createIcons();
            
            setTimeout(() => {
                btnElement.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }

        function copyApiUrl(btn) {
            const url = document.getElementById('api-url-input').value;
            copyToClipboard(url, btn, "");
        }

        function copyGetCode(btn) {
            const code = document.getElementById('code-get-display').textContent;
            copyToClipboard(code, btn);
        }

        function copySaveCode(btn) {
            const code = document.getElementById('code-save-display').textContent;
            copyToClipboard(code, btn);
        }

        function copyRules(btn) {
            const rules = `rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /artifacts/{appId}/public/data/tokens/{tokenId} {\n      allow read, write: if true;\n    }\n  }\n}`;
            copyToClipboard(rules, btn, "Copy Rules");
        }
    </script>
</body>
</html>
