<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Token Vault & File Editor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config for Animations -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'in': 'fade-in 0.3s ease-out',
                        'bounce': 'bounce 1s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Syntax highlighting simple */
        .code-block { background: #1e293b; color: #a5b4fc; }
        .string { color: #86efac; }
        .keyword { color: #f9a8d4; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            serverTimestamp, 
            deleteDoc, 
            doc,
            setDoc,
            getDoc,
            getDocs 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useCallback, useRef } = React;

        // --- Icon Components ---
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" viewBox="0 0 24 24" 
                fill="none" stroke="currentColor" strokeWidth="2" 
                strokeLinecap="round" strokeLinejoin="round" 
                className={className} {...props}
            >
                {children}
            </svg>
        );

        const Key = (props) => <IconBase {...props}><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1 5.3 5.3L3 21l-3-3 8-8Z"/><path d="M16 3a6 6 0 1 1-6 6"/></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
        const CheckCheck = (props) => <IconBase {...props}><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></IconBase>;
        const Clipboard = (props) => <IconBase {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Terminal = (props) => <IconBase {...props}><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></IconBase>;
        const Code = (props) => <IconBase {...props}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBYHrCidW3vrJHldgEbHqjeYYphl5f7DlM",
          authDomain: "texa-f4b30.firebaseapp.com",
          projectId: "texa-f4b30",
          storageBucket: "texa-f4b30.firebasestorage.app",
          messagingSenderId: "922894298029",
          appId: "1:922894298029:web:5c1bf375c2bb61b0cb8f24",
          measurementId: "G-QVBGFMKBG9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        try { getAnalytics(app); } catch (e) { console.log("Analytics skipped"); }

        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Dynamic App ID ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const COLLECTION_NAME = 'public_tokens';
        const FILES_COLLECTION_NAME = 'public_files';

        // --- Helper: Robust Copy ---
        const copyToClipboard = async (text) => {
            if (!text) return;
            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (!successful) throw new Error("Fallback copy failed");
                    console.log("Fallback copy successful");
                } finally {
                    document.body.removeChild(textArea);
                }
            };

            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    throw new Error("Clipboard API unavailable");
                }
            } catch (err) {
                console.warn("Modern Clipboard API failed, attempting fallback...", err);
                try {
                    fallbackCopy(text);
                } catch (fallbackErr) {
                    console.error("All copy attempts failed", fallbackErr);
                    console.error("Gagal menyalin otomatis. Silakan salin teks secara manual.");
                    throw fallbackErr;
                }
            }
        };

        // --- Components ---

        function ApiModal({ onClose }) {
            const currentHash = (location.hash || '').toLowerCase().replace(/^#/, '');
            const m = currentHash.match(/^\/editor\/(.+)$/);
            const currentFile = m ? decodeURIComponent(m[1]) : 'domain.txt';
            
            const [fileList, setFileList] = useState([]);

            useEffect(() => {
                // Use dynamic appId here
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const names = snapshot.docs.map(d => d.id).sort();
                    if(names.length > 0) setFileList(names);
                    else setFileList(['domain.txt']); 
                });
                return () => unsubscribe();
            }, []);

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in">
                      <div className="bg-slate-900 text-slate-200 rounded-xl shadow-2xl w-full max-w-2xl p-6 border border-slate-700 overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                            <h3 className="font-bold text-xl flex items-center gap-2 text-indigo-400">
                                <Terminal className="w-6 h-6" />
                                API Fetching Guide
                            </h3>
                            <button onClick={onClose}><X className="w-6 h-6 text-slate-400 hover:text-white" /></button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <p className="text-sm text-slate-400 mb-2">
                                    Panduan ini mencakup dua jenis penyimpanan: <strong>Vault Token Sementara</strong> (otomatis hapus) dan <strong>File Editor Permanen</strong>.
                                </p>
                            </div>

                            {/* --- SECTION 1: VAULT UTAMA --- */}
                            <div className="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl">
                                <h4 className="font-bold text-sm text-indigo-300 mb-2 flex items-center gap-2">
                                    <div className="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                                    VAULT UTAMA (Token Sementara)
                                </h4>
                                <p className="text-[10px] text-slate-400 mb-2">Gunakan URL ini untuk mengambil 1 token terbaru yang diinput di halaman depan (Vault).</p>
                                
                                <pre className="code-block p-4 rounded-lg overflow-x-auto text-xs font-mono select-all cursor-pointer" onClick={(e) => copyToClipboard(e.target.innerText)}>{`curl "https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/artifacts/${appId}/public/data/${COLLECTION_NAME}?orderBy=createdAt%20desc&pageSize=1&key=${firebaseConfig.apiKey}"`}
                                </pre>
                                <p className="text-[9px] text-right text-slate-500 mt-1">*Klik untuk menyalin cURL</p>
                            </div>

                            {/* --- SECTION 2: EDITOR FILES --- */}
                            <div className="pt-4 border-t border-slate-700">
                                <h4 className="font-bold text-sm text-white mb-4 flex items-center gap-2">
                                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    Endpoints File Editor (File Aktif)
                                </h4>
                                
                                <div className="space-y-4 max-h-60 overflow-y-auto pr-2">
                                    {fileList.map(file => (
                                        <div key={file} className="bg-slate-800 p-3 rounded-lg border border-slate-700">
                                            <div className="flex justify-between items-center mb-2">
                                                <code className="text-xs font-bold text-blue-300">{file}</code>
                                                <div className="flex gap-2">
                                                     <button onClick={() => copyToClipboard(`https://free-toket.teknoaiglobal.com/?token=TOKEN_DISINI&file=${file}#/editor/${file}`)} className="text-[10px] bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded text-white flex items-center gap-1">
                                                        <Zap className="w-3 h-3" /> URL Auto-Fill
                                                    </button>
                                                    <button onClick={() => copyToClipboard(`https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/artifacts/${appId}/public/data/public_files/${encodeURIComponent(file)}?key=${firebaseConfig.apiKey}`)} className="text-[10px] bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300 flex items-center gap-1">
                                                        <Copy className="w-3 h-3" /> API URL
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="text-[10px] text-slate-500 font-mono break-all line-clamp-1">
                                                ?token=...&file={file}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="pt-4 border-t border-slate-700">
                                <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors">
                                    Tutup Panduan API
                                </button>
                            </div>
                        </div>
                      </div>
                </div>
            )
        }

        function SettingsModal({ currentSeconds, onSave, onClose, autoReplace, onToggleReplace }) {
            const [val, setVal] = useState(currentSeconds.toString());
            const handleSubmit = (e) => {
                e.preventDefault();
                const num = parseInt(val, 10);
                if (!isNaN(num) && num > 0) onSave(num);
            };

            const presets = [
                { label: '1 Jam', value: 3600 },
                { label: '8 Jam', value: 28800 },
                { label: '24 Jam', value: 86400 }
            ];

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in">
                      <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                <Settings className="w-5 h-5 text-indigo-600" />
                                Pengaturan Waktu
                            </h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        
                        <div className="mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100 transition-colors hover:bg-indigo-100">
                            <label className="flex items-center justify-between cursor-pointer">
                                <span className="text-sm font-bold text-indigo-900 flex items-center gap-2">
                                    <RefreshCw className="w-4 h-4" /> Mode Timpa (Satu Token)
                                </span>
                                <input 
                                    type="checkbox" 
                                    checked={autoReplace} 
                                    onChange={(e) => onToggleReplace(e.target.checked)} 
                                    className="accent-indigo-600 w-5 h-5 cursor-pointer" 
                                />
                            </label>
                            <p className="text-xs text-indigo-600 mt-2 leading-relaxed">
                                Jika aktif, input token baru (Manual/Ekstensi) akan otomatis <strong>menghapus/menggantikan</strong> token lama. <br/>
                                <span className="text-red-500 font-bold mt-1 block">
                                    {autoReplace ? "⚠️ Durasi Auto Hapus dinonaktifkan (Permanen)." : ""}
                                </span>
                            </p>
                        </div>

                        <div className={`transition-opacity duration-300 ${autoReplace ? 'opacity-40 pointer-events-none grayscale' : 'opacity-100'}`}>
                            <p className="text-xs text-slate-500 mb-2 mt-4 font-bold uppercase tracking-wider">Durasi Auto Hapus</p>
                            <form onSubmit={handleSubmit}>
                                <input type="number" min="1" value={val} onChange={(e) => setVal(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-lg text-center font-bold" />
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    {presets.map(preset => (
                                        <button key={preset.value} type="button" onClick={() => setVal(preset.value.toString())} className={`px-2 py-2 text-xs font-bold rounded border transition-all ${val === preset.value.toString() ? 'bg-indigo-100 border-indigo-300 text-indigo-700' : 'bg-slate-50 hover:bg-slate-100 text-slate-600'}`}>
                                            {preset.label}
                                        </button>
                                    ))}
                                </div>
                                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 active:scale-95 transition-all"><Save className="w-4 h-4" /> Simpan Pengaturan</button>
                            </form>
                        </div>
                      </div>
                </div>
            )
        }

        function ConfirmationModal({ tokenText, onConfirm, onCancel, isDeleting, confirmLabel = "Ya, Hapus" }) {
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
                        <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                        <h3 className="text-lg font-bold mb-2">Konfirmasi Tindakan</h3>
                        <div className="bg-slate-100 p-2 rounded text-xs font-mono text-slate-600 line-clamp-3 mb-4 break-all">
                            {tokenText}
                        </div>
                        <div className="flex gap-2 justify-center">
                            <button onClick={onCancel} disabled={isDeleting} className="px-4 py-2 text-sm bg-slate-100 rounded-lg">Batal</button>
                            <button onClick={onConfirm} disabled={isDeleting} className="px-4 py-2 text-sm text-white bg-red-600 rounded-lg flex items-center gap-1">
                                {isDeleting ? 'Memproses...' : <><Trash2 className="w-4 h-4" /> {confirmLabel}</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function TokenCard({ note, onDelete, isLinkView }) {
            const [copied, setCopied] = useState(false);
            const [headerCopied, setHeaderCopied] = useState(false);
            const [revealed, setRevealed] = useState(true);

            const handleCopy = () => {
                copyToClipboard(note.token).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(() => {});
            };

            const handleCopyHeader = () => {
                const headerText = `Authorization: Bearer ${note.token}`;
                copyToClipboard(headerText).then(() => {
                    setHeaderCopied(true);
                    setTimeout(() => setHeaderCopied(false), 2000);
                }).catch(() => {});
            };

            return (
                <div className={`bg-white rounded-2xl shadow-xl border-2 overflow-hidden ${isLinkView ? 'border-indigo-600 ring-4 ring-indigo-100' : 'border-indigo-100'}`}>
                    <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className={`p-2 rounded-full ${isLinkView ? 'bg-indigo-600 text-white' : 'bg-white border text-indigo-600'}`}>
                                <Zap className="w-5 h-5" fill={isLinkView ? "white" : "none"} />
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-800 text-sm">
                                    {isLinkView ? "TOKEN DITERIMA" : (note.title || "Token Terbaru")}
                                </h3>
                                <p className="text-[10px] text-slate-500">
                                    {note.createdAt?.seconds 
                                       ? new Date(note.createdAt.seconds * 1000).toLocaleString() 
                                       : new Date().toLocaleString()}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-1">
                            <button onClick={() => setRevealed(!revealed)} className="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                                {revealed ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                            </button>
                            <button onClick={() => onDelete(note.id, false)} className="p-2 text-slate-400 hover:text-red-600 transition-colors" title="Hapus">
                                <Trash2 className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                    <div className="p-6 space-y-4">
                        {/* Token Box */}
                        <div onClick={handleCopy} className={`w-full bg-slate-800 text-slate-200 font-mono text-sm p-4 rounded-xl cursor-pointer hover:bg-slate-900 transition-colors relative ${revealed ? 'break-all' : 'truncate'}`}>
                            {revealed ? note.token : `${note.token.slice(0, 60)}•••••••`}
                            <div className="absolute top-2 right-2">
                                {copied ? <CheckCheck className="text-green-400 w-4 h-4" /> : <Copy className="text-slate-500 w-4 h-4" />}
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={handleCopy} className={`py-3 px-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm active:scale-95 border ${copied ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-50'}`}>
                                {copied ? <><CheckCheck className="w-4 h-4" /> Disalin</> : <><Copy className="w-4 h-4" /> Salin Token</>}
                            </button>
                            
                            <button onClick={handleCopyHeader} className={`py-3 px-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-md active:scale-95 text-white ${headerCopied ? 'bg-green-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                {headerCopied ? <><CheckCheck className="w-4 h-4" /> Header Ready!</> : <><Terminal className="w-4 h-4" /> Salin Auth Header</>}
                            </button>
                        </div>
                        
                        <div className="text-[10px] text-center text-slate-400 font-mono">
                            Format: Authorization: Bearer {note.token.slice(0, 10)}...
                        </div>
                    </div>
                </div>
            );
        }

        function FileEditor({ user, extensionToken, setExtensionToken, autoDeleteSeconds, autoReplace }) {
            const [activeFile, setActiveFile] = React.useState('domain.txt');
            const [fileList, setFileList] = React.useState([]);

            const [content, setContent] = React.useState('');
            const [isSaving, setIsSaving] = React.useState(false);
            const [lastSaved, setLastSaved] = React.useState(null);
            const [statusMsg, setStatusMsg] = React.useState('');
            const [loadingContent, setLoadingContent] = React.useState(false);
            
            const [appendInput, setAppendInput] = React.useState('');
            const [isAppending, setIsAppending] = React.useState(false);
            
            const [showDeleteModal, setShowDeleteModal] = React.useState(false);
            const [deleteAction, setDeleteAction] = React.useState(null);

            const timeoutRef = useRef(null);

            // Fetch File List
            React.useEffect(() => {
                // Use dynamic appId
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const names = snapshot.docs.map(d => d.id).sort();
                    setFileList(names);
                    
                    const hash = (location.hash || '').toLowerCase().replace(/^#/, '');
                    const m = hash.match(/^\/editor\/(.+)$/);
                    const hashFile = m ? decodeURIComponent(m[1]) : null;

                    if (hashFile && names.includes(hashFile)) {
                        setActiveFile(hashFile);
                    } else if (names.length > 0 && !names.includes(activeFile)) {
                        setActiveFile(names[0]);
                    } else if (names.length === 0) {
                        setActiveFile('');
                    } else if (!activeFile && names.length > 0) {
                        setActiveFile(names[0]);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Handle Extension Token
            React.useEffect(() => {
                if (extensionToken && user && activeFile && fileList.includes(activeFile)) {
                    const appendToActiveFile = async () => {
                        setIsSaving(true);
                        setStatusMsg(`Memproses ke ${activeFile}...`);
                        
                        try {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, activeFile);
                            const snap = await getDoc(docRef);
                            let newContent = extensionToken;
                            
                            if (!autoReplace && snap.exists()) {
                                const currentContent = snap.data().content || '';
                                if (currentContent.trim()) {
                                    newContent = currentContent + '\n' + extensionToken;
                                }
                            }
                            
                            const expirationTimestamp = autoReplace ? null : new Date(Date.now() + autoDeleteSeconds * 1000);

                            await setDoc(docRef, { 
                                content: newContent, 
                                updatedAt: serverTimestamp(), 
                                lastModifiedBy: user.uid,
                                expiresAt: expirationTimestamp 
                            }, { merge: true });

                            const actionText = autoReplace ? 'ditimpa' : 'ditambahkan';
                            setStatusMsg(`Sukses! Token ${actionText} ke ${activeFile}`);
                            
                            const newUrl = new URL(window.location);
                            newUrl.searchParams.delete('token');
                            newUrl.searchParams.delete('file');
                            window.history.replaceState({}, '', newUrl);
                            
                            setExtensionToken(null);
                        } catch (e) {
                            console.error("Auto-paste error:", e);
                            setStatusMsg('Gagal memproses data.');
                        } finally {
                            setIsSaving(false);
                            setTimeout(() => setStatusMsg(''), 3000);
                        }
                    };
                    appendToActiveFile();
                }
            }, [extensionToken, user, activeFile, fileList]);

            React.useEffect(() => {
                if (!user || !activeFile) return;
                setLoadingContent(true);
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, activeFile);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        let expiryTimeMs = 0;
                        if (data.expiresAt?.toMillis) expiryTimeMs = data.expiresAt.toMillis();
                        else if (data.expiresAt?.getTime) expiryTimeMs = data.expiresAt.getTime();
                        else if (typeof data.expiresAt === 'number') expiryTimeMs = data.expiresAt;

                        const now = Date.now();
                        if (expiryTimeMs > 0 && expiryTimeMs < now && data.content && data.content.trim() !== '') {
                             console.log(`Auto-clearing expired file: ${activeFile}`);
                             setDoc(docRef, { content: '', expiresAt: null }, { merge: true });
                             setContent('');
                        } else {
                             setContent(data.content || '');
                        }

                        if (data.updatedAt) setLastSaved(new Date(data.updatedAt.seconds * 1000));
                    } else {
                        setContent('');
                    }
                    setLoadingContent(false);
                }, () => { setLoadingContent(false); });
                return () => unsubscribe();
            }, [user, activeFile]);

            React.useEffect(() => {
                if (activeFile && !location.hash.includes(encodeURIComponent(activeFile))) {
                    location.hash = `#/editor/${encodeURIComponent(activeFile)}`;
                }
            }, [activeFile]);

            const saveContent = async (textToWrite, silent = false) => {
                if (!user || !activeFile) return;
                setIsSaving(true);
                try {
                    const expirationTimestamp = autoReplace ? null : new Date(Date.now() + autoDeleteSeconds * 1000);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, activeFile), { 
                        content: textToWrite, 
                        updatedAt: serverTimestamp(), 
                        lastModifiedBy: user.uid,
                        expiresAt: expirationTimestamp 
                    }, { merge: true });
                    setLastSaved(new Date());
                    if (!silent) { setStatusMsg('Berhasil menyimpan otomatis!'); setTimeout(() => setStatusMsg(''), 3000); }
                } finally { setIsSaving(false); }
            };

            const handleContentChange = (e) => { const newVal = e.target.value; setContent(newVal); if (timeoutRef.current) clearTimeout(timeoutRef.current); timeoutRef.current = setTimeout(() => { saveContent(newVal, true); }, 750); };
            const handlePaste = () => { setTimeout(() => { saveContent(content, false); }, 100); };
            const [headerCopied, setHeaderCopied] = React.useState(false);
            const copyHeader = () => { const tokens = content.split(/\r?\n/).map(s => s.trim()).filter(Boolean); const header = tokens.map(t => 'Authorization: Bearer ' + t).join('\n'); copyToClipboard(header).then(() => { setHeaderCopied(true); setTimeout(() => setHeaderCopied(false), 2000); }).catch(() => {}); };
            const openRawView = (autoCopy = false) => { const blob = new Blob([content], { type: 'text/plain' }); const url = URL.createObjectURL(blob); if (autoCopy) { navigator.clipboard.writeText(content).then(() => { console.log('Konten berhasil disalin ke clipboard!'); window.open(url, '_blank'); }); } else { window.open(url, '_blank'); } };
            
            const triggerDeleteContent = () => {
                setDeleteAction('clear_content');
                setShowDeleteModal(true);
            };

            const triggerDeleteFile = () => {
                setDeleteAction('delete_file');
                setShowDeleteModal(true);
            }

            const confirmAction = async () => {
                if (deleteAction === 'clear_content') {
                    setContent('');
                    await saveContent('', true);
                } else if (deleteAction === 'delete_file') {
                    if(!user || !activeFile) return;
                    setIsSaving(true);
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, activeFile));
                        setStatusMsg(`File ${activeFile} dihapus.`);
                        // setActiveFile logic handled by snapshot
                    } catch(e) {
                        console.error(e);
                        setStatusMsg('Gagal menghapus file.');
                    } finally {
                        setIsSaving(false);
                    }
                }
                setShowDeleteModal(false);
                setDeleteAction(null);
            };

            // --- Append Logic ---
            const handleAppend = async (textToAppend) => {
                if (!textToAppend.trim() || !user || !activeFile) return;
                setIsAppending(true);
                const newEntry = textToAppend.trim();
                
                const currentContent = content || '';
                const separator = currentContent.trim().length > 0 && !currentContent.endsWith('\n') ? '\n' : '';
                const newContent = currentContent + separator + newEntry;

                setContent(newContent); 
                setAppendInput('');
                
                try {
                    const expirationTimestamp = autoReplace ? null : new Date(Date.now() + autoDeleteSeconds * 1000);

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, activeFile), { 
                        content: newContent, 
                        updatedAt: serverTimestamp(), 
                        lastModifiedBy: user.uid,
                        expiresAt: expirationTimestamp
                    }, { merge: true });
                    setLastSaved(new Date());
                    setStatusMsg('Berhasil menambahkan item!');
                    setTimeout(() => setStatusMsg(''), 2000);
                } catch(e) {
                    console.error("Append failed", e);
                } finally {
                    setIsAppending(false);
                }
            };

            const handleAppendChange = (e) => {
                const val = e.target.value;
                setAppendInput(val);
                if (val.length > 20 && !isAppending) {
                    handleAppend(val);
                }
            };

            const handlePasteAppend = async () => {
                try {
                    let text = '';
                    if (navigator.clipboard) { 
                        try {
                           text = await navigator.clipboard.readText();
                        } catch (e) {
                           text = prompt("Paste text di sini:") || '';
                        }
                    } else {
                        text = prompt("Paste text di sini:") || '';
                    }
                    if (text.trim()) await handleAppend(text);
                } catch (err) { console.error("Paste failed"); }
            };

            const handleCreateFile = async () => {
                if (!user) { alert("Tunggu sebentar, sedang login..."); return; }
                const name = prompt("Masukkan nama file baru (contoh: notes.txt):");
                if (!name) return;
                const safeName = name.replace(/[^a-zA-Z0-9._-]/g, '');
                if (!safeName) { alert("Nama file tidak valid (Hanya huruf, angka, . _ -)."); return; }
                
                if (fileList.includes(safeName)) { alert("File sudah ada!"); setActiveFile(safeName); return; }

                setIsSaving(true);
                try {
                     await setDoc(doc(db, 'artifacts', appId, 'public', 'data', FILES_COLLECTION_NAME, safeName), {
                        content: '',
                        createdAt: serverTimestamp(),
                        lastModifiedBy: user.uid
                    });
                    setActiveFile(safeName);
                    setStatusMsg(`File ${safeName} dibuat!`);
                } catch(e) {
                    console.error(e);
                    setStatusMsg("Gagal membuat file.");
                    alert("Gagal membuat file. Pastikan Anda memiliki izin akses.");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden relative animate-in slide-in-from-bottom-4 duration-500">
                    {/* Delete Confirmation Modal */}
                    {showDeleteModal && (
                        <ConfirmationModal 
                            tokenText={deleteAction === 'delete_file' ? `HAPUS PERMANEN file "${activeFile}"?` : `Kosongkan isi konten file "${activeFile}"?`}
                            onConfirm={confirmAction}
                            onCancel={() => setShowDeleteModal(false)}
                            isDeleting={isSaving}
                            confirmLabel={deleteAction === 'delete_file' ? "Ya, Hapus File" : "Ya, Kosongkan"}
                        />
                    )}

                    {isSaving && (
                        <div className="absolute inset-0 bg-white/50 backdrop-blur-sm z-50 flex items-center justify-center">
                            <div className="bg-blue-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3">
                                <Loader2 className="w-5 h-5 animate-spin" />
                                <span className="font-semibold">Menyimpan perubahan...</span>
                            </div>
                        </div>
                    )}
                    <div className="bg-slate-50 border-b border-slate-200 overflow-x-auto flex items-center justify-between pr-2">
                        <div className="flex px-2 overflow-x-auto">
                            {fileList.map((file) => (
                                <button key={file} onClick={() => setActiveFile(file)} className={`px-4 py-3 text-sm font-mono whitespace-nowrap border-b-2 transition-colors ${activeFile === file ? 'border-blue-600 text-blue-700 font-bold bg-white' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>{file}</button>
                            ))}
                        </div>
                        <button onClick={handleCreateFile} className="ml-2 p-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg transition-colors flex items-center gap-1 text-xs font-bold whitespace-nowrap" title="Buat File Baru">
                            <Plus className="w-4 h-4" /> Baru
                        </button>
                    </div>
                    
                    {fileList.length === 0 ? (
                         <div className="p-12 text-center text-slate-400 flex flex-col items-center justify-center h-64">
                            <FileText className="w-12 h-12 mb-4 opacity-20" />
                            <p className="mb-4">Tidak ada file tersedia.</p>
                            <button onClick={handleCreateFile} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">Buat File Pertama</button>
                         </div>
                    ) : (
                        <div className="p-6">
                            {statusMsg && (
                                <div className="mb-4 p-3 bg-green-50 text-green-700 rounded-lg flex items-center justify-between text-sm">
                                    <span className="flex items-center gap-2"><CheckCheck className="w-4 h-4" /> {statusMsg}</span>
                                    <span>{new Date().toLocaleTimeString()}</span>
                                </div>
                            )}
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                                <label className="text-sm font-medium text-slate-700 flex items-center gap-2">
                                    File Aktif: <code className="text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded font-bold">{activeFile}</code>
                                    <button onClick={triggerDeleteFile} className="p-1 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded transition-colors" title="Hapus File Ini Permanen">
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </label>
                                {lastSaved && (<span className="text-xs text-slate-400">Disimpan: {lastSaved.toLocaleString()}</span>)}
                            </div>
                            <div className="flex flex-wrap gap-2 mb-4">
                                <button onClick={() => openRawView(false)} className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"><ExternalLink className="w-3 h-3" /> Lihat Raw</button>
                                <button onClick={() => openRawView(true)} className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded bg-green-50 text-green-700 hover:bg-green-100 transition-colors"><Clipboard className="w-3 h-3" /> Auto Salin (Raw)</button>
                                <button onClick={copyHeader} className={`flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded transition-colors text-white ${headerCopied ? 'bg-green-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}><Terminal className="w-3 h-3" /> Salin Auth Header</button>
                            </div>
                            <div className="relative mb-4">
                                {loadingContent ? (
                                    <div className="w-full h-72 bg-slate-100 rounded-lg animate-pulse flex items-center justify-center text-slate-400">Memuat konten...</div>
                                ) : (
                                    <textarea autoFocus value={content} onChange={handleContentChange} onPaste={handlePaste} placeholder="Ketik atau paste konten file di sini..." spellCheck={false} className="w-full h-64 p-4 border border-slate-300 rounded-lg shadow-inner font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50 text-slate-800 resize-y" />
                                )}
                            </div>
                            <div className="flex flex-wrap gap-3 mb-6">
                                <button onClick={() => saveContent(content)} disabled={isSaving} className="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 active:scale-95 transition-all flex items-center gap-2"><Save className="w-4 h-4" /> Simpan Full File</button>
                                <button onClick={async () => { try { const text = await navigator.clipboard.readText(); setContent(text); setTimeout(() => saveContent(text), 100); } catch (e) { console.error('Gunakan Ctrl+V jika tombol ini tidak berfungsi.'); } }} className="py-2 px-5 bg-slate-200 text-slate-800 font-medium rounded-lg hover:bg-slate-300 focus:outline-none active:scale-95 transition-all">Replace with Paste</button>
                                <button onClick={triggerDeleteContent} className="py-2 px-5 bg-orange-50 text-orange-600 font-medium rounded-lg hover:bg-orange-100 focus:outline-none active:scale-95 transition-all ml-auto flex items-center gap-1"><X className="w-4 h-4" /> Kosongkan Isi</button>
                            </div>

                            {/* --- Vault-like Append Section --- */}
                            <div className="bg-slate-100 rounded-xl shadow-sm border border-slate-300 p-4 opacity-95 hover:opacity-100 transition-opacity">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs font-bold text-slate-600 uppercase tracking-wider flex items-center gap-2"><Plus className="w-4 h-4" /> Quick Append (Menambahkan ke baris baru)</label>
                                    <button onClick={handlePasteAppend} className="text-xs flex items-center gap-1 text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded border border-indigo-200 bg-white"><Clipboard className="w-3 h-3" /> PASTE & APPEND</button>
                                </div>
                                <textarea value={appendInput} onChange={handleAppendChange} placeholder="Ketik atau paste untuk menambahkan ke baris paling bawah..." className="w-full p-3 rounded-lg border border-slate-300 focus:border-indigo-500 outline-none font-mono text-xs h-20 resize-none bg-white shadow-inner" />
                                <p className="text-[10px] text-slate-500 mt-1 text-right flex justify-between">
                                    <span className="flex items-center gap-1 text-indigo-400 font-semibold"><Clock className="w-3 h-3" /> {autoReplace ? '∞ (Nonaktif)' : `${autoDeleteSeconds}s`}</span>
                                    <span className="text-indigo-600 font-semibold">{isAppending ? 'Menambahkan...' : 'Siap'}</span>
                                    <span>Auto-upload &gt; 20 char</span>
                                </p>
                            </div>

                            <div className="text-[10px] text-center text-slate-400 font-mono mt-4">Format: Authorization: Bearer {(content.split(/\r?\n/).map(s => s.trim()).filter(Boolean)[0] || '').slice(0, 10)}...</div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [notes, setNotes] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const [tokenInput, setTokenInput] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const [directViewToken, setDirectViewToken] = useState(null);

            const [errorMsg, setErrorMsg] = useState('');
            const [permissionError, setPermissionError] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);
            const [tokenToDeleteId, setTokenToDeleteId] = useState(null);

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isApiModalOpen, setIsApiModalOpen] = useState(false); 
            const [extensionToken, setExtensionToken] = useState(null); 

            const [autoDeleteSeconds, setAutoDeleteSeconds] = useState(() => {
                try {
                    const saved = localStorage.getItem('autoDeleteSeconds');
                    return saved ? parseInt(saved, 10) : 86400;
                } catch (e) { return 86400; }
            });
            
            const [autoReplace, setAutoReplace] = useState(() => {
                try {
                    return localStorage.getItem('autoReplace') === 'true';
                } catch (e) { return false; }
            });

            const [activeTab, setActiveTab] = useState('tokens');

            useEffect(() => {
                localStorage.setItem('autoDeleteSeconds', autoDeleteSeconds.toString());
            }, [autoDeleteSeconds]);

            useEffect(() => {
                localStorage.setItem('autoReplace', autoReplace);
            }, [autoReplace]);

            // 1. Authentication
            useEffect(() => {
                signInAnonymously(auth).catch((err) => console.error("Auth error", err));
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const setTabFromLocation = () => {
                    const hash = (location.hash || '').toLowerCase();
                    const path = location.pathname.toLowerCase();
                    const src = hash ? hash.replace(/^#/, '') : path;
                    if (src.startsWith('/editor')) setActiveTab('editor'); else setActiveTab('tokens');
                };
                setTabFromLocation();
                const onHash = () => setTabFromLocation();
                const onPop = () => setTabFromLocation();
                window.addEventListener('hashchange', onHash);
                window.addEventListener('popstate', onPop);
                return () => { window.removeEventListener('hashchange', onHash); window.removeEventListener('popstate', onPop); };
            }, []);

            // 2. Data Fetching (Firestore)
            useEffect(() => {
                if (!user) return;
                // --- FIX: Use correct path for tokens ---
                const notesRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                const q = query(notesRef); 

                const unsubscribe = onSnapshot(q, 
                    (snapshot) => {
                        const fetchedNotes = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        fetchedNotes.sort((a, b) => {
                            const timeA = a.createdAt?.seconds || 0;
                            const timeB = b.createdAt?.seconds || 0;
                            return timeB - timeA;
                        });

                        setNotes(fetchedNotes);
                        setLoading(false);
                        setPermissionError(false);
                    },
                    (error) => {
                        if (error.code === 'permission-denied') setPermissionError(true);
                        setLoading(false);
                    }
                );
                return () => unsubscribe();
            }, [user]);

            // --- LOGIC UTAMA: SAVE ---
            const saveToken = async (tokenValue) => {
                if (!tokenValue.trim() || !user) return;
                setIsSubmitting(true);
                try {
                    // --- FIX: Use correct path for tokens ---
                    const notesRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    
                    if (autoReplace) {
                         const q = query(notesRef);
                         const snapshot = await getDocs(q);
                         const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                         await Promise.all(deletePromises);
                    }

                    const autoTitle = `Token ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
                    
                    const expirationTimestamp = autoReplace ? null : new Date(Date.now() + autoDeleteSeconds * 1000); 

                    await addDoc(notesRef, {
                        title: autoTitle,
                        token: tokenValue.trim(),
                        authorId: user.uid,
                        createdAt: serverTimestamp(),
                        expiresAt: expirationTimestamp
                    });
                    setTokenInput(''); 
                } catch (err) {
                    if (err.code === 'permission-denied') setPermissionError(true);
                } finally {
                    setIsSubmitting(false);
                }
            };

            // 3. URL Param Handling
            useEffect(() => {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const urlToken = params.get('token');
                    const targetFile = params.get('file'); 

                    if (targetFile) {
                          location.hash = `#/editor/${encodeURIComponent(targetFile)}`;
                          setActiveTab('editor');
                    }
                    
                    if (urlToken && urlToken.length > 5) {
                        const hash = location.hash || '';
                        
                        if (targetFile || hash.startsWith('#/editor')) {
                            setExtensionToken(urlToken);
                            setActiveTab('editor');
                        } else {
                            setDirectViewToken(urlToken);
                            if (user) {
                                saveToken(urlToken);
                            }
                        }
                    }
                } catch (e) {
                    console.log("URL param error");
                }
            }, [user]); 

            // --- LOGIC PENGHAPUSAN ---
            const deleteToken = useCallback(async (id, isAuto = false) => {
                if (!user) {
                    if (!isAuto) console.warn("Tunggu koneksi database...");
                    return;
                }
                if (!isAuto && tokenToDeleteId !== id) {
                    setTokenToDeleteId(id);
                    return;
                }
                try {
                    let realId = id;
                    if (id === 'temp-link-view') {
                        const matchingNote = notes.find(n => n.token === directViewToken);
                        if (matchingNote) {
                            realId = matchingNote.id;
                        } else {
                            setDirectViewToken(null);
                            setTokenToDeleteId(null);
                            try { window.history.replaceState({}, '', window.location.pathname); } catch(e) { console.log('Nav update failed'); }
                            return;
                        }
                    }

                    // --- FIX: Use correct path for tokens deletion ---
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, realId));
                    setTokenToDeleteId(null);

                    if (directViewToken && !isAuto) {
                        if (id === 'temp-link-view' || (notes.find(n => n.token === directViewToken)?.id === id)) {
                            setDirectViewToken(null);
                            try { window.history.replaceState({}, '', window.location.pathname); } catch(e) { console.log('Nav update failed'); }
                        }
                    }

                } catch (err) {
                    console.error("Delete err", err);
                    if (!isAuto) { 
                         console.error(`Gagal menghapus: ${err.message}. Pastikan Rules Firestore mengizinkan write.`);
                    }
                }
            }, [user, tokenToDeleteId, directViewToken, notes]);

            // 4. Auto-Deletion Check
            useEffect(() => {
                if (!user || loading || permissionError) return;

                const cleanupExpiredTokens = async () => {
                    setIsDeleting(true);
                    const now = Date.now();
                    
                    const expiredTokens = notes.filter(note => {
                        let expiryTimeMs = 0;
                        if (note.expiresAt?.toMillis) {
                            expiryTimeMs = note.expiresAt.toMillis();
                        } else if (note.expiresAt?.getTime) {
                            expiryTimeMs = note.expiresAt.getTime();
                        } else if (typeof note.expiresAt === 'number') {
                            expiryTimeMs = note.expiresAt;
                        }
                        return expiryTimeMs > 0 && expiryTimeMs < now;
                    });

                    if (expiredTokens.length > 0) {
                        for (const note of expiredTokens) {
                            await deleteToken(note.id, true);
                        }
                    }
                    setIsDeleting(false);
                };

                const intervalId = setInterval(cleanupExpiredTokens, 1 * 1000); 
                cleanupExpiredTokens();
                return () => clearInterval(intervalId);
            }, [user, notes, loading, permissionError, deleteToken]);

            const handleTokenInputChange = (e) => {
                const newText = e.target.value;
                setTokenInput(newText);
                if (newText.length > 20 && !isSubmitting) saveToken(newText);
            };
            
            const handlePasteFromClipboard = async () => {
                try {
                    let text = '';
                    if (navigator.clipboard) { 
                        try {
                           text = await navigator.clipboard.readText();
                        } catch (e) {
                           text = prompt("Paste text di sini:") || '';
                        }
                    } else {
                        text = prompt("Paste text di sini:") || '';
                    }
                    setTokenInput(text);
                    if (text.trim()) await saveToken(text);
                } catch (err) { setErrorMsg("Gagal Paste"); }
            };

            const viewFromLink = directViewToken ? {
                id: 'temp-link-view',
                title: 'Token dari Link',
                token: directViewToken,
                createdAt: { seconds: Date.now() / 1000 },
                expiresAt: null
            } : null;

            const displayNote = viewFromLink || (notes.length > 0 ? notes[0] : null);
            const isLinkMode = !!directViewToken;

            const resetView = () => {
                setDirectViewToken(null);
                setTokenInput('');
                try { window.history.replaceState({}, '', window.location.pathname); } catch(e) { console.log('Nav update failed'); }
            };

            const tokenToConfirm = isLinkMode 
                ? (tokenToDeleteId === 'temp-link-view' ? viewFromLink : null)
                : notes.find(n => n.id === tokenToDeleteId);

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col items-center pt-8 px-4 relative">
                
                {/* Modals */}
                {tokenToConfirm && (
                    <ConfirmationModal 
                        tokenText={tokenToConfirm.token}
                        onConfirm={() => deleteToken(tokenToConfirm.id, false)}
                        onCancel={() => setTokenToDeleteId(null)}
                        isDeleting={isDeleting}
                    />
                )}

                {isSettingsOpen && (
                    <SettingsModal 
                        currentSeconds={autoDeleteSeconds}
                        autoReplace={autoReplace}
                        onToggleReplace={setAutoReplace}
                        onSave={(val) => {
                            setAutoDeleteSeconds(val);
                            setIsSettingsOpen(false);
                        }}
                        onClose={() => setIsSettingsOpen(false)}
                    />
                )}

                {isApiModalOpen && (
                    <ApiModal onClose={() => setIsApiModalOpen(false)} />
                )}

                <div className="w-full max-w-3xl flex items-center justify-between mb-6">
                    <div className="flex items-center gap-2 text-indigo-600">
                        <Key className="w-8 h-8" />
                        <h1 className="text-2xl font-bold tracking-tight">{activeTab === 'editor' ? 'Web File Editor' : 'Public Token Vault'}</h1>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="bg-white p-1 rounded-xl shadow-sm border border-slate-200 flex gap-1 items-center">
                            <button onClick={() => { window.location.hash = ''; setActiveTab('tokens'); }} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'tokens' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}><Key className="w-4 h-4" /> Vault</button>
                            <button onClick={() => { location.hash = `#/editor/${encodeURIComponent('domain.txt')}`; setActiveTab('editor'); }} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'editor' ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}><FileText className="w-4 h-4" /> Editor</button>
                        </div>
                        <div className="h-6 w-px bg-slate-300 mx-1"></div>
                        <button onClick={() => setIsApiModalOpen(true)} className="p-2 flex items-center gap-1 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all text-xs font-bold border border-transparent hover:border-indigo-100" title="Cara Fetch API"><Code className="w-5 h-5" /><span className="hidden sm:inline">API</span></button>
                        <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-1.5 p-2 pr-3 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all group border border-transparent hover:border-indigo-100" title="Pengaturan Auto Hapus">
                            <Settings className="w-6 h-6 group-hover:rotate-45 transition-transform duration-500" />
                            <span className="text-[10px] font-mono font-bold bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded group-hover:bg-indigo-100 group-hover:text-indigo-700">⏱ {autoReplace ? '∞' : `${autoDeleteSeconds}s`}</span>
                        </button>
                    </div>
                </div>

                {activeTab === 'editor' ? (
                    <div className="w-full max-w-3xl">
                        <FileEditor user={user} extensionToken={extensionToken} setExtensionToken={setExtensionToken} autoDeleteSeconds={autoDeleteSeconds} autoReplace={autoReplace} />
                    </div>
                ) : (
                    <>
                        {permissionError && (
                            <div className="w-full max-w-2xl bg-red-100 border border-red-300 text-red-800 p-4 rounded-xl mb-4 text-center text-sm font-bold">
                                Gagal menghapus/menyimpan data. Mohon perbaiki Firestore Rules menjadi 'allow read, write: if true;' di Firebase Console.
                            </div>
                        )}
                        <div className="w-full max-w-3xl space-y-6">
                            {loading && !displayNote ? (
                                <div className="h-48 bg-slate-200 rounded-xl animate-pulse" />
                            ) : displayNote ? (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    {isLinkMode && (
                                        <div className="text-center mb-2 animate-bounce">
                                            <span className="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">LINK MODE</span>
                                        </div>
                                    )}
                                    <TokenCard note={displayNote} onDelete={deleteToken} isLinkView={isLinkMode} />
                                    {isLinkMode && (
                                        <button onClick={resetView} className="mt-6 mx-auto flex items-center gap-2 text-slate-500 hover:text-indigo-600 text-sm font-medium transition-colors"><Home className="w-4 h-4" />Tutup & Kembali ke Input Manual</button>
                                    )}
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl border-2 border-dashed border-slate-300 p-12 text-center text-slate-400">
                                    <Key className="w-12 h-12 mx-auto mb-2 opacity-20" />
                                    <p>Belum ada token.</p>
                                    <div className="mt-4 text-xs bg-slate-100 px-3 py-1 rounded-full inline-block flex items-center justify-center gap-2 max-w-[200px] mx-auto">
                                        <Clock className="w-3 h-3 text-slate-400" />
                                        <span>Auto-hapus: <strong>{autoReplace ? 'Nonaktif' : `${autoDeleteSeconds} detik`}</strong></span>
                                    </div>
                                </div>
                            )}
                            {!isLinkMode && (
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mt-8 opacity-90 hover:opacity-100 transition-opacity">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Upload Manual</label>
                                        <button onClick={handlePasteFromClipboard} className="text-xs flex items-center gap-1 text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded"><Clipboard className="w-3 h-3" /> PASTE</button>
                                    </div>
                                    <textarea value={tokenInput} onChange={handleTokenInputChange} placeholder="Paste token disini..." className="w-full p-3 rounded-lg border border-slate-300 focus:border-indigo-500 outline-none font-mono text-xs h-20 resize-none bg-slate-50" />
                                    <p className="text-[10px] text-slate-400 mt-1 text-right flex justify-between">
                                        <span className="flex items-center gap-1 text-indigo-400 font-semibold"><Clock className="w-3 h-3" /> {autoReplace ? '∞ (Nonaktif)' : `${autoDeleteSeconds}s`}</span>
                                        <span>Auto-upload &gt; 20 char</span>
                                    </p>
                                </div>
                            )}
                        </div>
                    </>
                )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
